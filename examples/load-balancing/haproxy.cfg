# HAProxy Load Balancer Configuration for Loom
#
# This configuration provides:
# - Load balancing with health checks
# - Session affinity via cookies
# - Connection limits
# - Stats dashboard
# - Graceful draining

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    
    # Performance
    maxconn 4096
    nbthread 4
    
defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  http-server-close
    option  forwardfor except 127.0.0.0/8
    option  redispatch
    retries 3
    timeout connect 5s
    timeout client  50s
    timeout server  50s
    timeout http-request 10s
    timeout http-keep-alive 10s
    
# Frontend - accepts incoming connections
frontend loom_frontend
    bind *:80
    
    # Optional: Redirect to HTTPS
    # redirect scheme https if !{ ssl_fc }
    
    default_backend loom_backend
    
    # Rate limiting (optional)
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny if { sc_http_req_rate(0) gt 100 }

# HTTPS Frontend (optional)
frontend loom_frontend_https
    bind *:443 ssl crt /etc/haproxy/certs/loom.pem
    
    default_backend loom_backend

# Backend - Loom instances
backend loom_backend
    balance leastconn
    
    # Session affinity via cookies
    cookie LOOM_INSTANCE insert indirect nocache
    
    # Health checks
    option httpchk GET /health/ready
    http-check expect status 200
    
    # Backend servers
    server instance1 loom-1:8080 cookie inst1 check inter 5s rise 2 fall 3 maxconn 1000
    server instance2 loom-2:8080 cookie inst2 check inter 5s rise 2 fall 3 maxconn 1000
    server instance3 loom-3:8080 cookie inst3 check inter 5s rise 2 fall 3 maxconn 1000
    
    # Connection timeouts
    timeout server 120s
    timeout connect 5s
    
    # Error handling
    option abortonclose

# Stats dashboard
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 5s
    stats show-legends
    stats show-node
    
    # Authentication (change password!)
    stats auth admin:changeme
    
    # Admin commands
    stats admin if TRUE
